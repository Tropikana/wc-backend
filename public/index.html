<!doctype html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Влизане с WalletConnect / MetaMask</title>
  <style>
    :root {
      --bg: #0f1216;
      --panel: #161b22;
      --text: #e6edf3;
      --muted: #9aa7b2;
      --accent: #2f81f7;
      --chip: #0b2942;
      --ok: #22c55e;
      --bad: #ef4444;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 16px}
    .card{background:var(--panel);border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:28px;align-items:flex-start}
    .left{flex:0 0 360px}
    .qr{width:100%;aspect-ratio:1;border-radius:12px;background:#0a0d10;display:grid;place-items:center;overflow:hidden}
    .qr img{width:100%;height:100%;object-fit:contain}
    .right{flex:1}
    .k{color:var(--muted);min-width:72px}
    .line{display:flex;gap:12px;align-items:center;margin:10px 0}
    .chip{background:var(--chip);color:var(--text);padding:6px 10px;border-radius:999px;font-size:13px}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .pill{background:#12263a;border-radius:999px;padding:4px 8px;margin-left:8px;font-size:12px;cursor:pointer}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Влизане с WalletConnect / MetaMask</h1>
  <p class="muted">1) Натисни бутона. 2) Сканирай QR с <b>вградения</b> скенер в MetaMask (иконката горе вдясно).</p>

  <div class="card">
    <div class="row">
      <div class="left">
        <button id="btnGen" class="btn">Генерирай QR</button>
        <div style="height:12px"></div>
        <div class="qr"><img id="qr" alt=""></div>
      </div>

      <div class="right">
        <div class="line"><span class="k">Статус:</span><span id="st" class="muted">Генерирам…</span></div>
        <div class="line"><span class="k">Адрес:</span><span id="addr" class="chip">—</span></div>
        <div class="line"><span class="k">Мрежа:</span><span id="chain" class="chip">—</span></div>

        <div style="height:6px"></div>
        <div class="line">
          <span class="chip">Ethereum Mainnet</span><span class="pill" onclick="switchTo(1)">Switch</span>
          <span class="chip">Linea</span><span class="pill" onclick="switchTo(59144)">Switch</span>
          <span class="chip">BNB Chain</span><span class="pill" onclick="switchTo(56)">Switch</span>
        </div>
        <div class="line">
          <span class="chip">BNB Testnet</span><span class="pill" onclick="switchTo(97)">Switch</span>
          <span class="chip">Polygon</span><span class="pill" onclick="switchTo(137)">Switch</span>
        </div>

        <div style="height:10px"></div>
        <button class="btn" onclick="copyAddr()">Копирай адрес</button>

        <div style="height:16px"></div>
        <div class="muted">Topic: <span id="topic">—</span></div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);

let POLL = null;

async function genQR() {
  $('st').textContent = 'Генерирам…';
  $('addr').textContent = '—';
  $('chain').textContent = '—';
  $('topic').textContent = '—';
  $('qr').src = '';
  try {
    const r = await fetch('/wc-uri');
    const j = await r.json();
    if (j.error) throw new Error(j.error);
    $('qr').src = j.png;
    $('st').textContent = 'Изчакай одобрение в портфейла…';

    // старт на polling, за да вземем адрес/мрежа след одобрение
    if (POLL) clearInterval(POLL);
    POLL = setInterval(updateStatus, 1500);
  } catch (e) {
    alert('Неуспешно /wc-uri\n' + e.message);
    $('st').textContent = 'Грешка';
  }
}

async function updateStatus() {
  try {
    const r = await fetch('/wc-status');
    const j = await r.json();
    if (!j.connected) return;

    $('st').textContent = 'Свързано';
    $('addr').textContent = j.address ? j.address.slice(0,6)+'…'+j.address.slice(-4) : '—';
    $('chain').textContent = j.chainName || ('Chain '+j.chainId);
    $('topic').textContent = j.topic || '—';

    if (POLL) { clearInterval(POLL); POLL = null; }
  } catch (_) {}
}

async function switchTo(chainId) {
  try {
    const r = await fetch('/switch-chain', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ targetChainId: chainId })
    });
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Switch failed');
    $('chain').textContent = j.chainName || ('Chain '+j.chainId);
    $('st').textContent = 'Свързано';
  } catch (e) {
    alert('Switch error: ' + e.message);
  }
}

async function copyAddr() {
  const lbl = $('addr').textContent;
  if (!lbl || lbl === '—') return;
  try {
    await navigator.clipboard.writeText(lbl);
    $('st').textContent = 'Адресът е копиран';
    setTimeout(()=> $('st').textContent='Свързано', 1000);
  } catch(_) {}
}

$('btnGen').onclick = genQR;
</script>
</body>
</html>

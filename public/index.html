<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Влизане с WalletConnect / MetaMask</title>
  <!-- Tailwind за бърз и чист UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Библиотека за генериране на QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    body { background: #0b0f14; }
    .card { background: #111827; border-radius: 1rem; }
    .pill { background:#0b1220; border:1px solid #1f2937; }
  </style>
</head>
<body class="min-h-screen text-gray-100 antialiased">
  <div class="max-w-6xl mx-auto px-6 pt-10 pb-20">
    <h1 class="text-3xl font-semibold mb-2">Влизане с WalletConnect / MetaMask</h1>
    <p class="text-gray-400 mb-8">
      1) Натисни бутона. 2) Сканирай QR с <span class="font-semibold">вградения</span> скенер в MetaMask (иконата горе вдясно).
    </p>

    <div class="card p-6 shadow-xl">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Лява част: QR -->
        <div>
          <button id="btn-generate" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 transition font-medium">
            Генерирай QR
          </button>

          <div class="mt-5 w-full aspect-square grid place-items-center rounded-2xl border border-gray-700 bg-[#0b1220]">
            <canvas id="qr-canvas" class="w-[300px] h-[300px]"></canvas>
            <div id="qr-placeholder" class="absolute text-gray-500 text-sm">
              Натисни „Генерирай QR“
            </div>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <button id="btn-open-mm" class="px-3 py-1.5 rounded-lg pill text-sm text-blue-300 hover:text-blue-200 hidden">
              Отвори в MetaMask (deeplink)
            </button>
            <span id="topic" class="text-xs text-gray-500"></span>
          </div>

          <p id="status" class="mt-3 text-sm text-gray-400">—</p>
        </div>

        <!-- Дясна част: статус/адрес/мрежа -->
        <div>
          <div class="flex items-center justify-between mb-4">
            <div class="text-gray-400">Статус:</div>
            <div id="status-chip" class="ml-2 px-2 py-0.5 text-sm rounded-lg bg-emerald-900/30 border border-emerald-800 text-emerald-300">
              Готово за генериране
            </div>
            <button id="btn-copy-addr" class="ml-auto px-3 py-1.5 rounded-lg pill text-sm text-blue-300 hover:text-blue-200"
                    disabled>Копирай адрес</button>
          </div>

          <div class="space-y-3">
            <div class="flex items-center gap-3">
              <div class="text-gray-400 w-16">Адрес:</div>
              <div id="addr" class="px-2 py-1 rounded-lg pill text-sm">—</div>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-gray-400 w-16">Мрежа:</div>
              <div id="chain" class="px-2 py-1 rounded-lg pill text-sm">—</div>
            </div>
          </div>

          <div class="mt-8">
            <div class="text-sm text-gray-400 mb-2">Бърза смяна на мрежа (по избор, след свързване):</div>
            <div class="flex flex-wrap gap-2 text-sm">
              <span class="px-3 py-1 rounded-full pill cursor-default">Ethereum Mainnet</span>
              <span class="px-3 py-1 rounded-full pill cursor-default">Linea</span>
              <span class="px-3 py-1 rounded-full pill cursor-default">BNB Chain</span>
              <span class="px-3 py-1 rounded-full pill cursor-default">BNB Testnet</span>
              <span class="px-3 py-1 rounded-full pill cursor-default">Polygon</span>
            </div>
          </div>

          <div class="mt-6 text-xs text-gray-500">
            Ако QR-ът не се появи: провери дали бекендът работи и дали променливата <code>WC_PROJECT_ID</code> е зададена.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Елементи
    const btnGenerate   = document.getElementById('btn-generate');
    const btnOpenMM     = document.getElementById('btn-open-mm');
    const btnCopyAddr   = document.getElementById('btn-copy-addr');
    const qrCanvas      = document.getElementById('qr-canvas');
    const qrPlaceholder = document.getElementById('qr-placeholder');
    const statusEl      = document.getElementById('status');
    const statusChip    = document.getElementById('status-chip');
    const addrEl        = document.getElementById('addr');
    const chainEl       = document.getElementById('chain');
    const topicEl       = document.getElementById('topic');

    // Състояние
    let lastURI = null;
    let lastTopic = null;
    let busy = false;

    function setStatusChip(text, color = 'emerald') {
      statusChip.textContent = text;
      statusChip.className =
        `ml-2 px-2 py-0.5 text-sm rounded-lg bg-${color}-900/30 border border-${color}-800 text-${color}-300`;
    }

    function clearQR() {
      const ctx = qrCanvas.getContext('2d');
      ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
      qrPlaceholder.classList.remove('hidden');
      btnOpenMM.classList.add('hidden');
      topicEl.textContent = '';
      lastURI = null;
      lastTopic = null;
    }

    async function renderQR(uri) {
      qrPlaceholder.classList.add('hidden');
      await QRCode.toCanvas(qrCanvas, uri, { margin: 2, width: 300 });
    }

    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    async function generateQR() {
      if (busy) return;
      busy = true;
      btnGenerate.disabled = true;
      setStatusChip('Генерирам…', 'blue');
      statusEl.textContent = 'Генерирам QR…';
      clearQR();

      let timeout = setTimeout(() => {
        statusEl.textContent = 'Таймаут при генериране. Опитай пак.';
        setStatusChip('Грешка / таймаут', 'red');
        btnGenerate.disabled = false;
        busy = false;
      }, 12000);

      try {
        const r = await fetch('/wc-uri', { method: 'GET' });
        const j = await r.json();

        if (!j.ok) {
          clearTimeout(timeout);
          if (j.error === 'busy') {
            statusEl.textContent = 'Сървърът в момента генерира друг QR. Опитай след 3–4 секунди.';
          } else {
            statusEl.textContent = 'Грешка: ' + (j.error || 'server');
          }
          setStatusChip('Грешка', 'red');
          return;
        }

        clearTimeout(timeout);
        lastURI = j.uri;
        lastTopic = j.topic;

        await renderQR(lastURI);
        setStatusChip('Сканирай QR от MetaMask', 'emerald');
        statusEl.textContent = 'Отвори MetaMask и използвай вградения скенер.';
        topicEl.textContent = 'Topic: ' + (lastTopic || '—');

        if (isMobile()) {
          btnOpenMM.classList.remove('hidden');
          btnOpenMM.onclick = () => {
            const deeplink = 'metamask://wc?uri=' + encodeURIComponent(lastURI);
            window.location.href = deeplink;
          };
        }
      } catch (e) {
        clearTimeout(timeout);
        setStatusChip('Грешка', 'red');
        statusEl.textContent = 'Мрежова грешка.';
      } finally {
        btnGenerate.disabled = false;
        busy = false;
      }
    }

    // Понастоящем адрес / мрежа не се извличат от фронтенда (сесията се държи от бекенда).
    // Показваме placeholders и позволяваме копиране на показаното съдържание.
    btnCopyAddr.addEventListener('click', async () => {
      const t = addrEl.textContent.trim();
      if (!t || t === '—') return;
      try {
        await navigator.clipboard.writeText(t);
        setStatusChip('Адресът е копиран', 'emerald');
      } catch (_) {}
    });

    // Начално състояние
    clearQR();
    setStatusChip('Готово за генериране', 'emerald');

    // Събития
    btnGenerate.addEventListener('click', generateQR);
  </script>
</body>
</html>

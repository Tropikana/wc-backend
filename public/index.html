<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <title>Влизане с WalletConnect / MetaMask</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#0f1318;color:#e6edf3;font-family:system-ui,Inter,Segoe UI,Roboto,Arial;margin:0;padding:24px}
    .card{background:#151a21;border-radius:14px;padding:24px;max-width:960px;margin:0 auto;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin-top:0}
    .btn{background:#2d6cdf;border:0;border-radius:10px;color:#fff;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .chip{display:inline-block;background:#111827;border:1px solid #263042;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:14px}
    .chip .mini{margin-left:8px;background:#1f2937;border:0;border-radius:999px;color:#c7d2fe;padding:4px 8px;cursor:pointer}
    #qr{width:420px;height:420px;background:#0b0e13;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#657182}
    .row{display:flex;gap:28px;flex-wrap:wrap}
    .muted{color:#9aa4b2}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>Влизане с WalletConnect / MetaMask</h1>
    <p class="muted">1) Натисни бутона. 2) Сканирай QR с <b>вградения</b> скенер в MetaMask (иконата горе вдясно).</p>

    <div class="row">
      <div>
        <button id="btn" class="btn">Генерирай QR</button>
        <div id="qr" style="margin-top:12px">QR ще се появи тук</div>
      </div>

      <div style="min-width:320px;flex:1">
        <div class="muted">Статус: <span id="status">Генерирам…</span></div>
        <div style="margin-top:10px">Адрес: <span id="addr" class="chip">—</span></div>
        <div style="margin-top:10px">Мрежа: <span id="chain" class="chip">—</span></div>

        <div style="margin-top:14px">
          <span class="chip">Ethereum Mainnet <button class="mini" data-chain="1">Switch</button></span>
          <span class="chip">Linea <button class="mini" data-chain="59144">Switch</button></span>
          <span class="chip">BNB Chain <button class="mini" data-chain="56">Switch</button></span>
          <span class="chip">BNB Testnet <button class="mini" data-chain="97">Switch</button></span>
          <span class="chip">Polygon <button class="mini" data-chain="137">Switch</button></span>
        </div>

        <div style="margin-top:16px">
          <button id="copy" class="btn" disabled>Копирай адрес</button>
        </div>

        <div class="muted" style="margin-top:14px">Topic: <span id="topic">—</span></div>
      </div>
    </div>
  </div>

<script>
const btn = document.getElementById("btn");
const statusEl = document.getElementById("status");
const qrEl = document.getElementById("qr");
const addrEl = document.getElementById("addr");
const chainEl = document.getElementById("chain");
const topicEl = document.getElementById("topic");
const copyBtn = document.getElementById("copy");

let polling = null;

function short(addr){ return addr ? addr.slice(0,6) + "..." + addr.slice(-4) : "—"; }

async function genQR(){
  statusEl.textContent = "Генерирам…";
  addrEl.textContent = "—";
  chainEl.textContent = "—";
  topicEl.textContent = "—";
  copyBtn.disabled = true;

  try{
    const r = await fetch("/wc-uri");
    const j = await r.json();
    if(!j.ok || !j.uri) throw new Error(j.error || "no uri");

    qrEl.innerHTML = "";
    await QRCode.toCanvas(j.uri, { width: 420, margin: 1 }, (err, canvas) => {
      if(err) throw err;
      qrEl.appendChild(canvas);
    });

    statusEl.textContent = "Чакам одобрение…";

    // започваме polling за одобрената сесия
    if(polling) clearInterval(polling);
    polling = setInterval(async () => {
      const r2 = await fetch("/wc-latest");
      const s = await r2.json();
      if(s.ok && s.connected){
        statusEl.textContent = "Свързано";
        addrEl.textContent = short(s.address);
        chainEl.textContent = s.chainName || ("Chain " + s.chainId);
        topicEl.textContent = s.topic;
        copyBtn.disabled = !s.address;
      }
    }, 1500);
  }catch(err){
    alert("Неуспешно /wc-uri");
    console.error(err);
  }
}

btn.addEventListener("click", genQR);

document.querySelectorAll(".mini[data-chain]").forEach(el => {
  el.addEventListener("click", async () => {
    const chainId = Number(el.getAttribute("data-chain"));
    try{
      const r = await fetch("/wc-switch",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ chainId })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || "switch failed");

      chainEl.textContent = j.chainName || ("Chain " + j.chainId);
      statusEl.textContent = "Свързано";
    }catch(e){
      alert("Неуспешна смяна на мрежа");
      console.error(e);
    }
  });
});

copyBtn.addEventListener("click", async () => {
  const r = await fetch("/wc-latest");
  const s = await r.json();
  if(s?.ok && s.connected && s.address){
    await navigator.clipboard.writeText(s.address);
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Влизане с WalletConnect / MetaMask</title>
  <!-- Лек тъмен стил -->
  <style>
    :root{
      --bg: #0f1218;
      --panel: #151a22;
      --muted: #8b93a3;
      --text: #e5e9f0;
      --accent: #3b82f6;
      --accent-2:#1d4ed8;
      --chip:#1f2937;
      --chip-txt:#d1d5db;
      --ok:#10b981;
      --err:#ef4444;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell, Noto Sans, "Helvetica Neue", Arial , "Apple Color Emoji", "Segoe UI Emoji";}
    .container{max-width:1200px;margin:0 auto;padding:32px 20px;}
    h1{font-size:28px;margin:0 0 8px;}
    .sub{color:var(--muted);font-size:14px;margin-bottom:22px}
    .card{background:var(--panel);border-radius:16px;padding:22px;box-shadow: 0 6px 24px rgba(0,0,0,.25);}
    .grid{display:grid;grid-template-columns:1fr 1fr; gap:24px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .qr-wrap{display:flex;align-items:center;justify-content:center;min-height:380px;border:1px dashed #273141;border-radius:12px;background:#0f141d}
    #qr{background:#fff;padding:8px;border-radius:8px}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0}
    .btn{background:var(--accent);color:white;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:hover{background:var(--accent-2)}
    .btn-secondary{background:#263244;color:#cdd6e1}
    .btn-chip{background:var(--chip);color:var(--chip-txt);border:none;border-radius:999px;padding:6px 12px;cursor:pointer}
    .btn-chip:hover{opacity:.9}
    .muted{color:var(--muted)}
    .kvs{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .kv{display:flex;gap:8px;align-items:center}
    .pill{padding:2px 10px;border-radius:999px;background:#1c2533;color:#cbd5e1}
    .status{font-weight:700}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--err)}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono","DejaVu Sans Mono",Consolas,"Courier New",monospace}
    .copy{cursor:pointer;border:1px solid #2a3547;border-radius:8px;padding:6px 8px}
    .small{font-size:13px}
    .sep{height:1px;background:#212c3b;margin:14px 0}
    .footer{margin-top:20px;color:var(--muted);font-size:12px}
  </style>
  <!-- QR генератор (лек, без зависимости) -->
  <script src="https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Влизане с WalletConnect / MetaMask</h1>
    <div class="sub">1) Натисни бутона. 2) Сканирай QR с <b>вградения</b> скенер в MetaMask (иконката горе вдясно).</div>

    <div class="card">
      <div class="grid">
        <!-- Лява колона: QR -->
        <div>
          <div class="row">
            <button id="btn-generate" class="btn">Генерирай QR</button>
            <span id="gen-hint" class="muted small">Натисни „Генерирай QR“</span>
          </div>
          <div id="qr-wrap" class="qr-wrap">
            <div id="qr"></div>
          </div>
        </div>

        <!-- Дясна колона: статус, адрес, мрежа, бутони -->
        <div>
          <div class="row">
            <div class="muted">Статус:</div>
            <div id="status" class="status">—</div>
          </div>

          <div class="row kvs">
            <div class="kv">
              <div class="muted">Адрес:</div>
              <div id="addr-pill" class="pill mono">—</div>
              <button id="btn-copy" class="btn-chip btn-secondary small">Копирай адрес</button>
            </div>
          </div>

          <div class="row kvs">
            <div class="kv">
              <div class="muted">Мрежа:</div>
              <div id="net-pill" class="pill">—</div>
            </div>
          </div>

          <div class="sep"></div>
          <div class="row muted">Бърза смяна на мрежа:</div>
          <div class="row" style="flex-wrap:wrap; gap:8px 10px">
            <button class="btn-chip" data-chain="1">Ethereum Mainnet</button>
            <button class="btn-chip" data-chain="59144">Linea</button>
            <button class="btn-chip" data-chain="56">BNB Chain</button>
            <button class="btn-chip" data-chain="97">BNB Testnet</button>
            <button class="btn-chip" data-chain="137">Polygon</button>
          </div>

          <div class="sep"></div>
          <div class="row kvs small">
            <div class="muted">Topic:</div>
            <div id="topic" class="mono muted">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">Ако QR-ът не се появи: проверете дали бекендът работи и дали променливата <span class="mono">WC_PROJECT_ID</span> е зададена.</div>
  </div>

<script>
(() => {
  // Ако бекендът е на друг URL – сменете:
  const BACKEND_BASE = location.origin; // напр. "https://wc-backend-***.onrender.com"
  const el = (id) => document.getElementById(id);

  const ui = {
    btnGenerate: el('btn-generate'),
    genHint: el('gen-hint'),
    qrWrap: el('qr-wrap'),
    qr: el('qr'),
    status: el('status'),
    addr: el('addr-pill'),
    net: el('net-pill'),
    topic: el('topic'),
    btnCopy: el('btn-copy'),
  };

  let pollTimer = null;
  let lastStatus = null;

  function setStatus(text, type = '') {
    ui.status.textContent = text;
    ui.status.className = 'status ' + (type || '');
  }

  function setAddr(address, short) {
    ui.addr.textContent = short || '—';
    ui.addr.title = address || '';
  }

  function setNetwork(name) {
    ui.net.textContent = name || '—';
  }

  function setTopic(t) {
    ui.topic.textContent = t || '—';
  }

  async function copyAddress() {
    const full = ui.addr.title;
    if (!full) return;
    try {
      await navigator.clipboard.writeText(full);
      ui.btnCopy.textContent = 'Копирано!';
      setTimeout(() => ui.btnCopy.textContent = 'Копирай адрес', 900);
    } catch (e) {
      alert('Неуспешно копиране');
    }
  }

  function clearQR() {
    ui.qr.innerHTML = '';
  }

  async function makeQR(value) {
    clearQR();
    // QRCode.toCanvas(canvas, text, options, cb)
    const canvas = document.createElement('canvas');
    await QRCode.toCanvas(canvas, value, { width: 260, margin: 1 });
    ui.qr.appendChild(canvas);
  }

  async function apiGET(path) {
    const r = await fetch(BACKEND_BASE + path, { method: 'GET' });
    return r.json();
  }
  async function apiPOST(path, body) {
    const r = await fetch(BACKEND_BASE + path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    return r.json();
  }

  async function startLogin() {
    setStatus('Генерирам...', '');
    ui.genHint.textContent = 'Генерирам QR...';
    clearQR();
    setAddr('', '—');
    setNetwork('—');
    setTopic('—');

    try {
      const data = await apiGET('/wc-uri');
      if (!data || !data.ok || !data.uri) {
        setStatus('Грешка при /wc-uri', 'err');
        ui.genHint.textContent = 'Грешка при /wc-uri';
        return;
      }
      await makeQR(data.uri);
      setStatus('Очаква сканиране...', '');
      ui.genHint.textContent = 'Сканирай QR кода от MetaMask → WalletConnect';

      // започваме да питаме за статус
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(checkStatus, 1500);
    } catch (e) {
      setStatus('Грешка при /wc-uri', 'err');
      ui.genHint.textContent = 'Грешка при /wc-uri';
      console.error(e);
    }
  }

  async function checkStatus() {
    try {
      const data = await apiGET('/status');
      if (!data || !data.ok) return;

      if (data.status === 'connected') {
        if (lastStatus !== 'connected') {
          // първо влизане
          setStatus('Свързано', 'ok');
          ui.genHint.textContent = 'Успешно свързване';
          // скрий QR за чист вид
          // ui.qrWrap.style.visibility = 'hidden';
        }
        lastStatus = 'connected';

        setAddr(data.address, data.addressShort);
        setNetwork(data.networkName);
        setTopic(data.topic);
      } else {
        lastStatus = 'not_found';
        setStatus('not_found', 'err');
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function switchChain(chainId) {
    try {
      const r = await apiPOST('/switch-chain', { chainId: Number(chainId) });
      if (!r.ok) {
        alert('Неуспешна смяна на мрежа: ' + (r.error || ''));
        return;
      }
      // обнови статус панела
      await checkStatus();
    } catch (e) {
      alert('Грешка при смяна на мрежа');
    }
  }

  // Слушатели
  ui.btnGenerate.addEventListener('click', startLogin);
  ui.btnCopy.addEventListener('click', copyAddress);

  // Бутони Switch
  document.addEventListener('click', (ev) => {
    const b = ev.target.closest('[data-chain]');
    if (!b) return;
    const id = b.getAttribute('data-chain');
    switchChain(id);
  });

  // При зареждане – опит за автоматично опресняване на статус (ако вече има сесия)
  checkStatus();
})();
</script>
</body>
</html>

<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Влизане с WalletConnect / MetaMask</title>
  <style>
    :root {
      --bg: #0f141a;
      --panel: #171e26;
      --text: #e5eef7;
      --muted: #9fb1c1;
      --primary: #2b78ff;
      --ok: #2ecc71;
      --pill: #0d2a4d;
    }
    body { margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width:1060px; margin:32px auto; padding:0 16px; }
    h1 { font-weight:700; margin:0 0 18px }
    .card { background:var(--panel); border-radius:14px; padding:22px; box-shadow:0 8px 40px rgba(0,0,0,.35); }
    .row { display:flex; gap:28px; align-items:flex-start; }
    .qr { width:420px; max-width:95%; border-radius:10px; background:#0b1117; padding:14px; }
    .qr img { width:100%; height:auto; display:block }
    .col { flex:1; min-width:280px }
    .btn { background:var(--primary); color:#fff; padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.5; cursor:not-allowed }
    .pill { display:inline-flex; align-items:center; gap:10px; background:var(--pill); color:#cfe1ff; padding:6px 10px; border-radius:999px; margin:6px 10px 0 0; font-size:14px }
    .sub { color:var(--muted); }
    .status-ok { color:var(--ok); font-weight:700 }
    code.small { font-size:12px; color:#b7c7d6 }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Влизане с WalletConnect / MetaMask</h1>
    <p class="sub">1) Натисни бутона. 2) Сканирай QR с <b>вградения</b> скенер в MetaMask (иконката горе вдясно).</p>

    <div class="card">
      <div class="row">
        <div class="qr">
          <button id="btnGen" class="btn">Генерирай QR</button>
          <div id="qrBox" style="margin-top:12px"></div>
        </div>

        <div class="col">
          <div style="margin:6px 0 14px">
            Статус: <span id="status" class="sub">Чака сканиране…</span>
          </div>

          <div style="margin:10px 0">
            Адрес: <span id="addr" class="pill">—</span>
          </div>
          <div style="margin:6px 0 14px">
            Мрежа: <span id="chain" class="pill">—</span>
          </div>

          <!-- бързи “Switch” бутони -->
          <div id="switches" style="margin:6px 0 12px">
            <span class="pill">Ethereum Mainnet <button class="btn-mini" data-hex="0x1">Switch</button></span>
            <span class="pill">Linea <button class="btn-mini" data-hex="0xe738">Switch</button></span>
            <span class="pill">BNB Chain <button class="btn-mini" data-hex="0x38">Switch</button></span>
            <span class="pill">BNB Testnet <button class="btn-mini" data-hex="0x61">Switch</button></span>
            <span class="pill">Polygon <button class="btn-mini" data-hex="0x89">Switch</button></span>
          </div>

          <button id="copyBtn" class="btn" disabled>Копирай адрес</button>

          <div style="margin-top:16px">
            <div class="sub">Topic: <code class="small" id="topic">—</code></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const btn = $("#btnGen");
const qrBox = $("#qrBox");
const statusEl = $("#status");
const addrEl = $("#addr");
const chainEl = $("#chain");
const copyBtn = $("#copyBtn");
const topicEl = $("#topic");

let current = { topic: null, address: null, chainHex: null };

// Генерира нов QR и започва очакване за одобрение
btn.onclick = async () => {
  resetUI();
  btn.disabled = true;
  statusEl.textContent = "Генерирам…";

  try {
    // 1) вземи wc-uri
    const r = await fetch("/wc-uri");
    const data = await r.json();
    if (!data?.uri) throw new Error("Неуспешно /wc-uri");

    // 2) покажи QR (използвам png, генериран от сървъра)
    qrBox.innerHTML = `<img alt="qr" src="${data.qr}" />`;
    statusEl.textContent = "Сканирай QR…";

    // 3) чакай одобрение (еднократен long-poll)
    const appr = await fetch("/wc-approve/" + data.id);
    const sess = await appr.json();
    if (sess.error) throw new Error(sess.error);

    // 4) UI
    current.topic = sess.topic;
    current.address = sess.address;
    current.chainHex = sess.chainHex;

    statusEl.innerHTML = '<span class="status-ok">Свързано</span>';
    addrEl.textContent = short(sess.address);
    chainEl.textContent = sess.chainName;
    topicEl.textContent = sess.topic;

    copyBtn.disabled = false;
  } catch (e) {
    console.log(e);
    statusEl.textContent = "Грешка";
    alert(e.message || e);
  } finally {
    btn.disabled = false;
  }
};

copyBtn.onclick = async () => {
  if (!current.address) return;
  await navigator.clipboard.writeText(current.address);
  copyBtn.textContent = "Копирано!";
  setTimeout(()=> (copyBtn.textContent = "Копирай адрес"), 1200);
};

// Switch бутони – изпращаме wallet_switchEthereumChain през бекенда
document.querySelectorAll(".btn-mini").forEach(el => {
  el.className = "btn";
  el.style.cssText = "padding:4px 8px;border-radius:999px;font-size:12px;background:#1b4fff;";
  el.onclick = async () => {
    if (!current.topic) return;
    const hex = el.dataset.hex;
    try {
      el.disabled = true;
      const r = await fetch("/wc-switch", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          topic: current.topic,
          targetChainIdHex: hex,
          selectedAccount: null
        })
      });
      const out = await r.json();
      if (out.ok) {
        // рефреш стойностите (най-сигурно е да помолим портфейла за chainId, но сървърът вече го връща)
        statusEl.innerHTML = '<span class="status-ok">Свързано</span>';
        chainEl.textContent = chainNameFromHex(out.chainIdHex);
      } else {
        throw new Error(out.error || "switch failed");
      }
    } catch (e) {
      alert(e.message || e);
    } finally {
      el.disabled = false;
    }
  };
});

function short(a){ return a ? a.slice(0,6)+"…"+a.slice(-3) : "—"; }
function chainNameFromHex(hex){
  const map = {
    "0x1":"Ethereum Mainnet",
    "0x38":"BNB Chain",
    "0x61":"BNB Testnet",
    "0x89":"Polygon",
    "0xe738":"Linea"
  };
  return map[(hex||"").toLowerCase()] || "Unknown";
}
function resetUI(){
  qrBox.innerHTML = "";
  statusEl.textContent = "Чака сканиране…";
  addrEl.textContent = "—";
  chainEl.textContent = "—";
  copyBtn.disabled = true;
  topicEl.textContent = "—";
  current = { topic:null, address:null, chainHex:null };
}
</script>
</body>
</html>

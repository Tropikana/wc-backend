<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>WC Backend – Test Console</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0e1013;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 16px 24px;
      background: #171a1f;
      border-bottom: 1px solid #282c34;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      padding: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
    }
    section {
      background: #171a1f;
      border: 1px solid #2a2f3a;
      border-radius: 12px;
      padding: 16px 18px;
      flex: 1 1 380px;
      box-sizing: border-box;
    }
    section h2 {
      margin-top: 0;
      font-size: 18px;
    }
    label {
      display: block;
      margin: 6px 0 2px;
      font-size: 13px;
      color: #bbb;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #444b57;
      background: #0f1115;
      color: #f5f5f5;
      font-size: 13px;
    }
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
    }
    button {
      background: #2f81f7;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 8px 14px;
      margin-top: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    button.secondary {
      background: #444b57;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1;
      min-width: 140px;
    }
    .small {
      font-size: 12px;
      color: #aaa;
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #2f81f7;
      color: white;
      margin-left: 4px;
    }
    #qr {
      margin-top: 8px;
      text-align: center;
    }
    #qr img {
      max-width: 220px;
      background: white;
      padding: 8px;
      border-radius: 8px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      min-height: 80px;
      resize: vertical;
      background: #0f1115;
      color: #f5f5f5;
      border-radius: 6px;
      border: 1px solid #444b57;
      font-size: 12px;
      padding: 6px 8px;
    }
    .pill {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid #444b57;
      font-size: 11px;
      margin-right: 6px;
      margin-top: 3px;
    }
    .pill span {
      color: #2f81f7;
    }
  </style>
</head>
<body>
<header>
  <h1>WalletConnect Backend – тестова конзола <span class="badge">Sim Game Session</span></h1>
</header>

<main>
  <!-- Настройки / API -->
  <section>
    <h2>1. Настройки</h2>
    <label for="apiBase">API адрес на сървъра</label>
    <input type="text" id="apiBase" />
    <p class="small">
      Ако отваряш тази страница от същия домейн като сървъра (Render), остави стойността както е.  
      Ако тестваш локално, можеш да сложиш например <code>http://localhost:3000</code>.
    </p>
    <button id="btnSaveApi" class="secondary">Запази API адреса</button>
    <div id="apiStatus" class="status"></div>
  </section>

  <!-- Логване с портфейл -->
  <section>
    <h2>2. Логване с портфейл (QR)</h2>
    <label for="chainRef">Chain (eip155:<span class="small">например 80002 за Polygon Amoy</span>)</label>
    <!-- по подразбиране: Amoy -->
    <input type="text" id="chainRef" value="eip155:80002" />
    <button id="btnGetQr">Генерирай QR за WalletConnect</button>
    <div id="qr"></div>
    <div class="status" id="wcStatus"></div>
  </section>

  <!-- Симулиране на игрово действие -->
  <section>
    <h2>3. Симулирай игрово действие (billing & on-chain)</h2>

    <div class="small">
      1) Избери действие и въведи параметри<br />
      2) Натисни „Вземи цена“ → ще получиш колко native токен трябва да плати играчът<br />
      3) „Плати“ → ще извика <code>eth_sendTransaction</code> към портфейла<br />
      4) След успешното плащане сървърът автоматично ще изпълни действието в смарт договора
    </div>

    <label for="actionType">Действие (actionType)</label>
    <select id="actionType">
      <option value="RESOURCE_NFT_MINT">RESOURCE_NFT_MINT (минт ресурс)</option>
      <option value="RESOURCE_NFT_BURN">RESOURCE_NFT_BURN (burn ресурс)</option>
      <option value="CURRENCY_MINT">CURRENCY_MINT (минт валута)</option>
      <option value="CURRENCY_BURN">CURRENCY_BURN (burn валута)</option>
      <option value="LAND_NFT_MINT">LAND_NFT_MINT (минт парцел)</option>
      <option value="PARCEL_ACTIVATE_BUILDING">PARCEL_ACTIVATE_BUILDING (строеж/активиране)</option>
      <option value="PARCEL_SET_BUILDING_ACTIVE">PARCEL_SET_BUILDING_ACTIVE (on/off сграда)</option>
    </select>

    <!-- Полета за детайли (динамично спрямо actionType) -->
    <div id="detailsFields" style="margin-top: 10px;"></div>

    <div class="row" style="margin-top: 10px;">
      <div>
        <button id="btnQuote" class="secondary">1) Вземи цена</button>
      </div>
      <div>
        <button id="btnPay" class="secondary" disabled>2) Плати</button>
      </div>
      <div>
        <!-- Остава като fallback, но вече не е задължителен -->
        <button id="btnComplete" disabled>3) Изпълни действие</button>
      </div>
    </div>

    <div style="margin-top: 8px;">
      <div class="pill">Цена: <span id="priceEther">–</span> native</div>
      <div class="pill">Treasury: <span id="priceTreasury">–</span></div>
    </div>

    <div class="status" id="billingStatus"></div>
  </section>

  <!-- Логове -->
  <section>
    <h2>4. Лог</h2>
    <textarea id="log" readonly></textarea>
    <button id="btnClearLog" class="secondary">Изчисти лог</button>
  </section>
</main>

<script>
  // ---------- Помощни ----------
  const $ = (id) => document.getElementById(id);

  function logLine(msg) {
    const area = $("log");
    const ts = new Date().toISOString().replace("T", " ").replace("Z", "");
    area.value += `[${ts}] ${msg}\n`;
    area.scrollTop = area.scrollHeight;
  }

  function setStatus(id, msg) {
    $(id).textContent = msg;
    if (msg) logLine(msg);
  }

  // ---------- Константи за Polygon Amoy ----------
  // chainId 80002 (hex 0x13882)
  const AMOY_CHAIN_ID_HEX = "0x13882";
  const AMOY_CHAIN_REF = "eip155:80002";

  // ---------- Настройки ----------
  const apiInput = $("apiBase");
  const apiStatus = $("apiStatus");
  const defaultApi = window.location.origin;

  apiInput.value = localStorage.getItem("wc_api_base") || defaultApi;

  $("btnSaveApi").onclick = () => {
    const v = apiInput.value.trim();
    if (!v) {
      apiStatus.textContent = "Моля, въведи валиден API адрес.";
      return;
    }
    localStorage.setItem("wc_api_base", v);
    apiStatus.textContent = "Записано.";
    logLine(`API base set to ${v}`);
  };

  function apiBase() {
    return apiInput.value.trim() || defaultApi;
  }

  // ---------- WalletConnect логика ----------
  let wcPendingId = null;
  let wcSession = null;
  let wcPollTimer = null;
  let lastQuote = null;
  let lastPaymentTxHash = null;

  function clearWcSession() {
    wcPendingId = null;
    wcSession = null;
    if (wcPollTimer) {
      clearInterval(wcPollTimer);
      wcPollTimer = null;
    }
    $("wcStatus").textContent = "Няма активна сесия.";
    $("qr").innerHTML = "";
  }

  clearWcSession();

  $("btnGetQr").onclick = async () => {
    try {
      clearWcSession();

      const chainRef = $("chainRef").value.trim() || AMOY_CHAIN_REF;
      const url = apiBase() + "/wc-uri?chain=" + encodeURIComponent(chainRef);

      setStatus("wcStatus", "Създаване на WC сесия...");
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();

      wcPendingId = data.id;
      setStatus(
        "wcStatus",
        "Сесия създадена. Сканирай QR кода с MetaMask / друго WC приложение."
      );

      const uriEncoded = encodeURIComponent(data.uri);
      $("qr").innerHTML =
        '<img src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' +
        uriEncoded +
        '" alt="WC QR" />';

      wcPollTimer = setInterval(checkWcStatus, 1500);
    } catch (e) {
      setStatus("wcStatus", "Грешка при генериране на WC URI: " + e.message);
    }
  };

  // helper за изпращане на WC JSON-RPC заявки (ползваме го и за switch/add chain, и за плащане)
  async function sendWcRequest(method, params) {
    if (!wcSession) throw new Error("Няма активна WC сесия.");

    const body = {
      topic: wcSession.topic,
      method,
      chainRef: AMOY_CHAIN_REF, // спазваме същата мрежа навсякъде
      params,
    };

    const resp = await fetch(apiBase() + "/wc-request", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(body),
    });
    const data = await resp.json();
    if (!resp.ok || data.ok === false) {
      throw new Error(data.error || "HTTP " + resp.status);
    }
    return data.result;
  }

  // автоматично добавяне/превключване към Amoy в MetaMask
  async function ensureAmoyNetwork() {
    try {
      // 1) пробваме директно да сменим мрежата
      await sendWcRequest("wallet_switchEthereumChain", [
        { chainId: AMOY_CHAIN_ID_HEX },
      ]);
      logLine("wallet_switchEthereumChain към Amoy изпълнена.");
    } catch (err) {
      const msg = String(err.message || err);
      // ако верне, че веригата не е добавена -> добавяме я
      if (msg.includes("4902") || msg.toLowerCase().includes("unrecognized chain")) {
        logLine("Amoy не е добавена. Опитваме wallet_addEthereumChain...");
        await sendWcRequest("wallet_addEthereumChain", [
          {
            chainId: AMOY_CHAIN_ID_HEX,
            chainName: "Polygon Amoy Testnet",
            nativeCurrency: {
              name: "Polygon",
              symbol: "POL",
              decimals: 18,
            },
            rpcUrls: ["https://rpc-amoy.polygon.technology/"],
            blockExplorerUrls: ["https://amoy.polygonscan.com/"],
          },
        ]);

        // и после пак switch
        await sendWcRequest("wallet_switchEthereumChain", [
          { chainId: AMOY_CHAIN_ID_HEX },
        ]);
        logLine("Мрежата Amoy беше добавена и избрана в MetaMask.");
      } else {
        logLine("Грешка при смяна на мрежата: " + msg);
      }
    }
  }

  async function checkWcStatus() {
    if (!wcPendingId) return;
    try {
      const url = apiBase() + "/wc-status?id=" + encodeURIComponent(wcPendingId);
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();

      if (data.status === "approved") {
        wcSession = {
          topic: data.topic,
          address: data.address,
          chainRef: data.selectedChainRef,
          chainId: data.chainId,
        };
        clearInterval(wcPollTimer);
        wcPollTimer = null;
        $("wcStatus").textContent =
          "Свързано: " +
          wcSession.address +
          " @ " +
          (data.networkName || wcSession.chainRef);
        logLine(
          "WC session approved for " + wcSession.address + " on " + wcSession.chainRef
        );

        // веднага опитваме да превключим/добавим Polygon Amoy
        ensureAmoyNetwork().catch((e) =>
          logLine("Неуспешна автоматична смяна на мрежата: " + e.message)
        );
      } else if (data.status === "expired") {
        clearWcSession();
        setStatus("wcStatus", "Сесията изтече. Генерирай нов QR.");
      } else if (data.status === "pending") {
        // още чакаме
      } else {
        clearWcSession();
        setStatus("wcStatus", "Сесията не е намерена.");
      }
    } catch (e) {
      setStatus("wcStatus", "Грешка при проверка на статус: " + e.message);
    }
  }

  // ---------- Детайли за действията (формата) ----------
  const detailsDiv = $("detailsFields");
  const actionSelect = $("actionType");

  function renderDetailsFields() {
    const type = actionSelect.value;
    let html = "";

    if (type.startsWith("RESOURCE_NFT_")) {
      html += `
        <label>resourceId</label>
        <input type="number" id="detail_resourceId" value="1" min="1" />
        <label>amount</label>
        <input type="number" id="detail_amount" value="1" min="1" />
      `;
    } else if (type.startsWith("CURRENCY_")) {
      html += `
        <label>amount (цяло число токени)</label>
        <input type="number" id="detail_amount" value="10" min="1" />
      `;
    } else if (type === "LAND_NFT_MINT") {
      html += `
        <label>tokenId (ID на парцела)</label>
        <input type="number" id="detail_tokenId" value="1" min="1" />
      `;
    } else if (type === "PARCEL_ACTIVATE_BUILDING") {
      html += `
        <label>landId</label>
        <input type="number" id="detail_landId" value="1" min="1" />
        <label>buildingType (0..5)</label>
        <input type="number" id="detail_buildingType" value="0" min="0" max="5" />
      `;
    } else if (type === "PARCEL_SET_BUILDING_ACTIVE") {
      html += `
        <label>landId</label>
        <input type="number" id="detail_landId" value="1" min="1" />
        <label>buildingType (0..5)</label>
        <input type="number" id="detail_buildingType" value="0" min="0" max="5" />
        <label>
          <input type="checkbox" id="detail_active" checked />
          active (отметнато = включена сграда)
        </label>
      `;
    }

    detailsDiv.innerHTML = html;
  }

  actionSelect.addEventListener("change", () => {
    renderDetailsFields();
    lastQuote = null;
    lastPaymentTxHash = null;
    $("priceEther").textContent = "–";
    $("priceTreasury").textContent = "–";
    $("btnPay").disabled = true;
    $("btnComplete").disabled = true;
  });

  renderDetailsFields();

  function buildDetails(actionType) {
    const details = {};

    if (actionType.startsWith("RESOURCE_NFT_")) {
      details.resourceId = parseInt($("detail_resourceId").value, 10);
      details.amount = parseInt($("detail_amount").value, 10);
    } else if (actionType.startsWith("CURRENCY_")) {
      details.amount = parseInt($("detail_amount").value, 10);
    } else if (actionType === "LAND_NFT_MINT") {
      details.tokenId = parseInt($("detail_tokenId").value, 10);
    } else if (actionType === "PARCEL_ACTIVATE_BUILDING") {
      details.landId = parseInt($("detail_landId").value, 10);
      details.buildingType = parseInt($("detail_buildingType").value, 10);
    } else if (actionType === "PARCEL_SET_BUILDING_ACTIVE") {
      details.landId = parseInt($("detail_landId").value, 10);
      details.buildingType = parseInt($("detail_buildingType").value, 10);
      details.active = $("detail_active").checked;
    }

    return details;
  }

  // ---------- Billing flow ----------
  $("btnQuote").onclick = async () => {
    try {
      const actionType = actionSelect.value;
      const url =
        apiBase() +
        "/billing/quote?actionType=" +
        encodeURIComponent(actionType);
      setStatus("billingStatus", "Заявка за цена...");
      const resp = await fetch(url);
      const data = await resp.json();
      if (!resp.ok) {
        throw new Error(data.error || "HTTP " + resp.status);
      }

      lastQuote = data;
      lastPaymentTxHash = null;
      $("priceEther").textContent = data.priceEther;
      $("priceTreasury").textContent = data.treasury;
      $("btnPay").disabled = !wcSession;
      $("btnComplete").disabled = true;

      setStatus(
        "billingStatus",
        "Цена за " +
          actionType +
          " = " +
          data.priceEther +
          " (wei: " +
          data.priceWei +
          ")"
      );
    } catch (e) {
      setStatus("billingStatus", "Грешка при /billing/quote: " + e.message);
    }
  };

  $("btnPay").onclick = async () => {
    try {
      if (!wcSession) {
        return setStatus("billingStatus", "Няма активна WC сесия.");
      }
      if (!lastQuote) {
        return setStatus(
          "billingStatus",
          "Първо вземи цена с бутона „Вземи цена“."
        );
      }

      const tx = {
        to: lastQuote.treasury,
        value: lastQuote.priceWei, // hex от сървъра
      };

      $("btnPay").disabled = true;
      $("btnComplete").disabled = true;

      setStatus(
        "billingStatus",
        "Изпращане на плащането към портфейла (WC request)..."
      );

      // използваме helper-а, вместо ръчно да викаме /wc-request
      const txHash = await sendWcRequest("eth_sendTransaction", [tx]);
      lastPaymentTxHash = txHash;

      setStatus(
        "billingStatus",
        "Плащането е изпратено. txHash=" +
          txHash +
          "\nИзчакване и автоматично изпълнение на действието..."
      );

      // Автоматично изпълнение на действието
      await runComplete();
    } catch (e) {
      $("btnPay").disabled = false;
      setStatus("billingStatus", "Грешка при плащането: " + e.message);
    }
  };

  async function runComplete() {
    try {
      if (!wcSession) {
        return setStatus("billingStatus", "Няма активна WC сесия.");
      }
      if (!lastQuote || !lastPaymentTxHash) {
        return setStatus(
          "billingStatus",
          "Няма запомнено плащане. Първо „Вземи цена“ и „Плати“."
        );
      }

      const actionType = actionSelect.value;
      const details = buildDetails(actionType);

      $("btnComplete").disabled = true;

      setStatus(
        "billingStatus",
        "Изчакване на плащането и изпълнение на действие в смарт договора..."
      );

      const body = {
        actionType,
        txHash: lastPaymentTxHash,
        playerAddress: wcSession.address,
        details,
      };

      const resp = await fetch(apiBase() + "/billing/complete", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await resp.json();
      if (!resp.ok || data.ok === false) {
        throw new Error(data.error || "HTTP " + resp.status);
      }

      setStatus(
        "billingStatus",
        "Успех! paymentTx=" +
          data.paymentTxHash +
          " ; onchainTx=" +
          data.onchainTxHash
      );
      $("btnComplete").disabled = true;
    } catch (e) {
      $("btnComplete").disabled = false;
      setStatus("billingStatus", "Грешка при /billing/complete: " + e.message);
    }
  }

  // Ръчен fallback – просто вика същото
  $("btnComplete").onclick = async () => {
    await runComplete();
  };

  $("btnClearLog").onclick = () => {
    $("log").value = "";
  };
</script>
</body>
</html>

<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <title>Влизане с WalletConnect / MetaMask</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f141a; --fg:#e6edf3; --muted:#9fb0bf;
      --card:#0b1116; --pill:#1f2a36; --accent:#3b82f6;
      --good:#22c55e; --bad:#ef4444;
    }
    body{background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:18px;padding:20px 24px;box-shadow:0 0 0 1px #ffffff14}
    h1{font-size:28px;margin:0 0 12px}
    .row{display:flex;gap:24px;align-items:flex-start}
    .left{width:360px}
    .right{flex:1;min-width:280px}
    button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-block;background:var(--pill);padding:6px 10px;border-radius:999px;font-size:13px;margin-right:8px}
    .status{font-weight:600}
    .ok{color:var(--good)} .err{color:var(--bad)}
    #qr{width:360px;height:360px;background:#0a0f14;border-radius:12px;display:grid;place-items:center;overflow:hidden}
    #qr img{width:100%;height:100%;object-fit:contain}
    .net-row{margin:8px 0}
    .net-row .pill{margin-bottom:8px}
    .copy{margin-top:10px}
    .topic{color:var(--muted);font-size:12px;margin-top:10px;word-break:break-all}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Влизане с WalletConnect / MetaMask</h1>
  <p>1) Натисни бутона. 2) Сканирай QR с <b>вградения</b> скенер в MetaMask (иконката горе вдясно).</p>

  <div class="card">
    <div class="row">
      <div class="left">
        <button id="btn" onclick="start()" >Генерирай QR</button>
        <div id="qr" style="margin-top:12px;"></div>
      </div>

      <div class="right">
        <div>Статус: <span id="st" class="status">—</span></div>
        <div style="margin-top:10px;">Адрес: <span id="addr" class="pill">—</span></div>
        <div style="margin-top:6px;">Мрежа: <span id="net" class="pill">—</span></div>

        <div class="net-row" style="margin-top:12px;">
          <span class="pill">Ethereum Mainnet</span><button class="pill" onclick="sw(1)">Switch</button>
          <span class="pill">Linea</span><button class="pill" onclick="sw(59144)">Switch</button>
          <span class="pill">BNB Chain</span><button class="pill" onclick="sw(56)">Switch</button>
          <span class="pill">Polygon</span><button class="pill" onclick="sw(137)">Switch</button>
        </div>

        <button class="copy" onclick="copyAddr()">Копирай адрес</button>
        <div id="topic" class="topic"></div>
      </div>
    </div>
  </div>
</div>

<script>
let token = null;
let fullAddress = "";

function el(id){ return document.getElementById(id); }
function setStatus(txt, ok){
  el("st").textContent = txt;
  el("st").className = "status " + (ok ? "ok":"err");
}
function showQR(dataUri){
  el("qr").innerHTML = `<img src="${dataUri}">`;
}

async function start(){
  el("qr").innerHTML = "";
  el("addr").textContent = "—";
  el("net").textContent  = "—";
  el("topic").textContent = "";
  setStatus("Генерирам…", true);

  try{
    const u = await fetch("/wc-uri").then(r=>r.json());
    if(!u.ok){ alert("Неуспешно /wc-uri"); setStatus("Грешка", false); return; }

    // рендерираме QR локално (използвай вграден скенер на MetaMask)
    const {uri} = u;
    token = u.token;

    // бърз embed на QR без canvas библиотеки (Google Charts)
    const data = encodeURIComponent(uri);
    const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=360x360&chl=${data}`;
    showQR(qrUrl);

    setStatus("Генерирам…", true);

    // чакаме одобрението (long poll)
    const sess = await fetch(`/wait-session?token=${token}`).then(r=>r.json());
    if(!sess.ok){ alert("Неуспешно одобрение"); setStatus("Грешка", false); return; }

    fullAddress = sess.address;
    el("addr").textContent = sess.addressShort;
    el("net").textContent  = sess.chainLabel;
    el("topic").textContent = "Topic: " + sess.topic;
    setStatus("Свързано", true);
  }catch(e){
    console.error(e);
    alert("Грешка при свързване");
    setStatus("Грешка", false);
  }
}

async function sw(chainId){
  if(!token){ alert("Няма активна сесия."); return; }
  try{
    const r = await fetch("/switch", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ token, chainId })
    }).then(r=>r.json());

    if(!r.ok){ alert("Грешка при смяна: " + (r.error||"")); return; }
    el("net").textContent = r.chainLabel || ("eip155:" + r.chainId);
  }catch(e){
    console.error(e);
    alert("Грешка при смяна");
  }
}

function copyAddr(){
  if(!fullAddress){ return; }
  navigator.clipboard.writeText(fullAddress);
}
</script>
</body>
</html>

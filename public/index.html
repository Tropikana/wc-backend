<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Влизане с WalletConnect / MetaMask</title>
  <style>
    :root { --bg:#0b0d10; --panel:#14171b; --text:#e6e9ee; --muted:#a7b0bd; --accent:#4da3ff; --border:#22262c; }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:720px;margin:0 auto}
    h1{margin:0 0 12px}
    p.muted{color:var(--muted);margin-top:0}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    button{background:var(--accent);color:#03111f;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    .row{margin:12px 0}
    #qr img{width:260px;height:260px;border-radius:12px;display:block}
    code{background:#0f1318;border:1px solid #1c2128;color:#d7e3ff;padding:.2rem .4rem;border-radius:6px}
    .error{color:#ff8787}
    .ok{color:#aef39c}
    .stat{color:#ffd38b}
    .cols{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .pill{background:#0f1318;border:1px solid #1c2128;border-radius:12px;padding:6px 10px;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Влизане с WalletConnect / MetaMask</h1>
    <p class="muted">1) Натисни бутона. 2) Сканирай QR с <b>вградения</b> скенер в MetaMask (иконата горе вдясно).</p>
    <div class="card">
      <div class="row"><button id="btn">Генерирай QR</button></div>
      <div id="qr" class="row"></div>
      <div id="status" class="row stat"></div>
      <div id="result" class="row"></div>
    </div>
  </div>

  <script>
    const btn=document.getElementById("btn"),qrDiv=document.getElementById("qr"),statusEl=document.getElementById("status"),resultEl=document.getElementById("result");
    const base=""; let poll=null; const stop=()=>{ if(poll){clearInterval(poll); poll=null;} };

    async function copy(text){
      try{ await navigator.clipboard.writeText(text); alert("Адресът е копиран."); }catch{}
    }

    btn.addEventListener("click", async ()=>{
      stop(); qrDiv.innerHTML=""; statusEl.textContent="Създаване на сесия..."; statusEl.className="stat"; resultEl.textContent="";
      try{
        const r=await fetch(base+"/wc-uri");
        if(!r.ok){ const t=await r.text().catch(()=> ""); statusEl.innerHTML=`<span class="error">Грешка при /wc-uri</span>`; if(t) resultEl.innerHTML=`<code>${t.slice(0,400)}</code>`; return; }
        const {id,uri,expiresAt}=await r.json();

        const bg="14171b", fg="ffffff";
        const img=`https://api.qrserver.com/v1/create-qr-code/?size=400x400&bgcolor=${bg}&color=${fg}&data=${encodeURIComponent(uri)}`;
        qrDiv.innerHTML=`<img src="${img}" alt="WalletConnect QR">`;
        statusEl.innerHTML=`Статус: <b>pending</b> (валиден до <code>${expiresAt}</code>)`;

        poll=setInterval(async ()=>{
          const s=await fetch(base+`/wc-status?id=${encodeURIComponent(id)}`).then(x=>x.json());
          if(s.status==="approved"){
            stop();
            statusEl.innerHTML=`<span class="ok">Свързано</span>`;
            const short = (a)=> a ? a.slice(0,6)+"…"+a.slice(-4) : "";
            resultEl.innerHTML = `
              <div class="cols"><div>Адрес:</div><div class="pill">${short(s.address || "")}</div></div>
              <div class="cols"><div>Мрежа:</div><div class="pill">${s.networkName || ("eip155:"+s.chainId)}</div></div>
              <div style="margin-top:8px"><button id="cp">Копирай адрес</button></div>
              <div style="margin-top:8px"><small>Topic: <code>${s.topic}</code></small></div>
            `;
            document.getElementById("cp").onclick=()=>copy(s.address||"");
          } else if (s.status==="expired"){
            stop(); statusEl.innerHTML=`<span class="error">Статус: expired</span> — генерирай нов QR.`;
          } else if (s.status==="not_found"){
            statusEl.innerHTML=`<span class="error">Статус: not_found</span>`;
          } else {
            statusEl.innerHTML=`Статус: <b>pending</b> — одобри в MetaMask`;
          }
        }, 2000);
      }catch(e){
        statusEl.innerHTML=`<span class="error">Грешка при /wc-uri</span>`;
        resultEl.textContent=String(e);
      }
    });
  </script>
</body>
</html>
